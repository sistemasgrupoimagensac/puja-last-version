document.addEventListener("DOMContentLoaded",function(){const d=document.getElementById("proyectoForm"),s=d?d.dataset.proyectoId:null,n=document.getElementById("proyectoImgDropZone"),o=document.getElementById("proyectoImgInput"),p=document.getElementById("proyectoImgPreviewContainer"),c=document.getElementById("proyectoImgUploadButton"),f=400*1024,l=50,m=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),h=document.querySelectorAll(".delete-image-btn"),E=document.querySelectorAll(".principal-checkbox");function u(e=!0){c.disabled=e,c.textContent=e?"Subiendo imágenes...":"Subir / Actualizar Imágenes"}h.forEach(e=>{e.addEventListener("click",function(){const t=this.dataset.id;confirm("¿Estás seguro de que deseas eliminar esta imagen?")&&fetch(`/proyectos/${s}/imagenes/${t}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":m}}).then(r=>r.json()).then(r=>{r.message==="Imagen eliminada correctamente."?(this.parentElement.remove(),alert("Imagen eliminada correctamente.")):response.status===500?alert("El estado de la imagen fue actualizado, pero no se pudo eliminar de Wasabi."):alert("Error al eliminar la imagen.")}).catch(r=>{console.error("Error al eliminar la imagen:",r),alert("Hubo un error al eliminar la imagen.")})})});let a=[];E.forEach(e=>{e.addEventListener("change",function(){this.checked&&v(this.value)})});function v(e){fetch(`/proyectos/${s}/imagenes-principal`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":m},body:JSON.stringify({image_id:e})}).then(t=>t.json()).then(t=>{t.success?alert("Imagen principal actualizada correctamente."):alert("Error al actualizar la imagen principal.")}).catch(t=>{console.error("Error al actualizar la imagen principal:",t)})}n.addEventListener("click",()=>o.click()),o.addEventListener("change",()=>{const e=Array.from(o.files);g(e),o.value=""}),n.addEventListener("dragover",e=>{e.preventDefault(),n.classList.add("dragover")}),n.addEventListener("dragleave",()=>n.classList.remove("dragover")),n.addEventListener("drop",e=>{e.preventDefault(),n.classList.remove("dragover"),g(Array.from(e.dataTransfer.files))}),c.addEventListener("click",()=>{if(a.length===0){alert("No has seleccionado ninguna imagen.");return}if(!s){alert("Por favor, primero guarde el proyecto.");return}u(!0);const e=new FormData;a.forEach(t=>{e.append("images[]",t)}),fetch(`/proyectos/${s}/imagenes`,{method:"POST",body:e,headers:{"X-CSRF-TOKEN":m}}).then(t=>{if(!t.ok)throw new Error(`Error al subir las imágenes: ${t.statusText}`);return t.json()}).then(t=>{alert("Imágenes subidas correctamente.")}).catch(t=>{console.error("Error al subir las imágenes:",t),alert("Hubo un error al subir las imágenes.")}).finally(()=>{u(!1)})});function g(e){e.forEach(t=>{y(t)&&(a.push(t),I(t))}),a.length>=l&&(o.disabled=!0)}function y(e){return e.size>f?(alert(`La imagen ${e.name} supera el tamaño máximo de 400KB.`),!1):["image/jpeg","image/png","image/webp"].includes(e.type)?a.length>=l?(alert("Has alcanzado el límite de 50 imágenes."),!1):!0:(alert(`El archivo ${e.name} no es un formato de imagen válido.`),!1)}function I(e){const t=new FileReader;t.onload=r=>{const i=document.createElement("div");i.classList.add("image-preview"),i.innerHTML=`
              <img src="${r.target.result}" alt="${e.name}">
              <button class="remove-image-btn btn-close d-flex justify-content-center align-items-center" data-name="${e.name}">
                <i class="fa-solid fa-xmark"></i>
              </button>
          `,p.appendChild(i),i.querySelector(".remove-image-btn").addEventListener("click",()=>{b(e.name),i.remove()})},t.readAsDataURL(e)}function b(e){a=a.filter(t=>t.name!==e),o.disabled=a.length>=l}});
