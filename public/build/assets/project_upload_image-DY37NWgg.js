document.addEventListener("DOMContentLoaded",function(){const m=document.getElementById("proyectoForm"),i=m?m.dataset.proyectoId:null,n=document.getElementById("proyectoImgDropZone"),o=document.getElementById("proyectoImgInput"),g=document.getElementById("proyectoImgPreviewContainer"),u=document.getElementById("proyectoImgUploadButton"),f=400*1024,l=50,d=document.querySelector('meta[name="csrf-token"]').getAttribute("content");document.querySelectorAll(".delete-image-btn").forEach(e=>{e.addEventListener("click",function(){const t=this.dataset.id;confirm("¿Estás seguro de que deseas eliminar esta imagen?")&&fetch(`/proyectos/${i}/imagenes/${t}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":d}}).then(r=>r.json()).then(r=>{r.message==="Imagen eliminada correctamente."?(this.parentElement.remove(),alert("Imagen eliminada correctamente.")):response.status===500?alert("El estado de la imagen fue actualizado, pero no se pudo eliminar de Wasabi."):alert("Error al eliminar la imagen.")}).catch(r=>{console.error("Error al eliminar la imagen:",r),alert("Hubo un error al eliminar la imagen.")})})});let a=[];n.addEventListener("click",()=>o.click()),o.addEventListener("change",()=>{const e=Array.from(o.files);c(e),o.value=""}),n.addEventListener("dragover",e=>{e.preventDefault(),n.classList.add("dragover")}),n.addEventListener("dragleave",()=>n.classList.remove("dragover")),n.addEventListener("drop",e=>{e.preventDefault(),n.classList.remove("dragover"),c(Array.from(e.dataTransfer.files))}),u.addEventListener("click",()=>{if(a.length===0){alert("No has seleccionado ninguna imagen.");return}if(!i){alert("El ID del proyecto no está definido.");return}const e=new FormData;a.forEach(t=>{e.append("images[]",t)}),fetch(`/proyectos/${i}/imagenes`,{method:"POST",body:e,headers:{"X-CSRF-TOKEN":d}}).then(t=>{if(!t.ok)throw new Error(`Error al subir las imágenes: ${t.statusText}`);return t.json()}).then(t=>{alert("Imágenes subidas correctamente."),console.log("Imágenes subidas:",t.images)}).catch(t=>{console.error("Error al subir las imágenes:",t),alert("Hubo un error al subir las imágenes.")})});function c(e){e.forEach(t=>{p(t)&&(a.push(t),E(t))}),a.length>=l&&(o.disabled=!0)}function p(e){return e.size>f?(alert(`La imagen ${e.name} supera el tamaño máximo de 400KB.`),!1):["image/jpeg","image/png","image/webp"].includes(e.type)?a.length>=l?(alert("Has alcanzado el límite de 50 imágenes."),!1):!0:(alert(`El archivo ${e.name} no es un formato de imagen válido.`),!1)}function E(e){const t=new FileReader;t.onload=r=>{const s=document.createElement("div");s.classList.add("image-preview"),s.innerHTML=`
              <img src="${r.target.result}" alt="${e.name}">
              <button class="remove-image-btn btn-close d-flex justify-content-center align-items-center" data-name="${e.name}">
                <i class="fa-solid fa-xmark"></i>
              </button>
          `,g.appendChild(s),s.querySelector(".remove-image-btn").addEventListener("click",()=>{v(e.name),s.remove()})},t.readAsDataURL(e)}function v(e){a=a.filter(t=>t.name!==e),o.disabled=a.length>=l}});
