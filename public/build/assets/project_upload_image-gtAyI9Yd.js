document.addEventListener("DOMContentLoaded",function(){const m=document.getElementById("proyectoForm"),s=m?m.dataset.proyectoId:null,n=document.getElementById("proyectoImgDropZone"),o=document.getElementById("proyectoImgInput"),g=document.getElementById("proyectoImgPreviewContainer"),u=document.getElementById("proyectoImgUploadButton"),p=400*1024,c=50,l=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),f=document.querySelectorAll(".delete-image-btn"),h=document.querySelectorAll(".principal-checkbox");f.forEach(e=>{e.addEventListener("click",function(){const t=this.dataset.id;confirm("¿Estás seguro de que deseas eliminar esta imagen?")&&fetch(`/proyectos/${s}/imagenes/${t}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":l}}).then(r=>r.json()).then(r=>{r.message==="Imagen eliminada correctamente."?(this.parentElement.remove(),alert("Imagen eliminada correctamente.")):response.status===500?alert("El estado de la imagen fue actualizado, pero no se pudo eliminar de Wasabi."):alert("Error al eliminar la imagen.")}).catch(r=>{console.error("Error al eliminar la imagen:",r),alert("Hubo un error al eliminar la imagen.")})})});let a=[];h.forEach(e=>{e.addEventListener("change",function(){this.checked&&E(this.value)})});function E(e){fetch(`/proyectos/${s}/imagenes-principal`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":l},body:JSON.stringify({image_id:e})}).then(t=>t.json()).then(t=>{t.success?alert("Imagen principal actualizada correctamente."):alert("Error al actualizar la imagen principal.")}).catch(t=>{console.error("Error al actualizar la imagen principal:",t)})}n.addEventListener("click",()=>o.click()),o.addEventListener("change",()=>{const e=Array.from(o.files);d(e),o.value=""}),n.addEventListener("dragover",e=>{e.preventDefault(),n.classList.add("dragover")}),n.addEventListener("dragleave",()=>n.classList.remove("dragover")),n.addEventListener("drop",e=>{e.preventDefault(),n.classList.remove("dragover"),d(Array.from(e.dataTransfer.files))}),u.addEventListener("click",()=>{if(a.length===0){alert("No has seleccionado ninguna imagen.");return}if(!s){alert("Por favor, primero guarde el proyecto.");return}const e=new FormData;a.forEach(t=>{e.append("images[]",t)}),fetch(`/proyectos/${s}/imagenes`,{method:"POST",body:e,headers:{"X-CSRF-TOKEN":l}}).then(t=>{if(!t.ok)throw new Error(`Error al subir las imágenes: ${t.statusText}`);return t.json()}).then(t=>{alert("Imágenes subidas correctamente."),console.log("Imágenes subidas:",t.images)}).catch(t=>{console.error("Error al subir las imágenes:",t),alert("Hubo un error al subir las imágenes.")})});function d(e){e.forEach(t=>{v(t)&&(a.push(t),y(t))}),a.length>=c&&(o.disabled=!0)}function v(e){return e.size>p?(alert(`La imagen ${e.name} supera el tamaño máximo de 400KB.`),!1):["image/jpeg","image/png","image/webp"].includes(e.type)?a.length>=c?(alert("Has alcanzado el límite de 50 imágenes."),!1):!0:(alert(`El archivo ${e.name} no es un formato de imagen válido.`),!1)}function y(e){const t=new FileReader;t.onload=r=>{const i=document.createElement("div");i.classList.add("image-preview"),i.innerHTML=`
              <img src="${r.target.result}" alt="${e.name}">
              <button class="remove-image-btn btn-close d-flex justify-content-center align-items-center" data-name="${e.name}">
                <i class="fa-solid fa-xmark"></i>
              </button>
          `,g.appendChild(i),i.querySelector(".remove-image-btn").addEventListener("click",()=>{I(e.name),i.remove()})},t.readAsDataURL(e)}function I(e){a=a.filter(t=>t.name!==e),o.disabled=a.length>=c}});
