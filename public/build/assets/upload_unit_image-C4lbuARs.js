document.addEventListener("DOMContentLoaded",function(){const d=document.getElementById("unidadImgUploadButton"),o=document.getElementById("unidadImgInput"),h=document.getElementById("unidadImgDropZone"),l=document.getElementById("unidadImgPreviewContainer"),c=document.getElementById("unidadExistingImagesContainer"),I=document.getElementById("unidadImgUploadModal"),s=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),v=4e3*10240,m=50,p=document.querySelectorAll(".delete-image-unidad-btn");function u(e=!0){d.disabled=e,d.textContent=e?"Subiendo imágenes...":"Subir / Actualizar Imágenes"}p.forEach(e=>{e.addEventListener("click",function(){const a=this.dataset.id;confirm("¿Seguro de que deseas eliminar esta imagen de la unidad?")&&fetch(`/unidades/imagenes/${a}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":s}}).then(n=>n.json()).then(n=>{n.message==="Imagen eliminada correctamente."?(this.parentElement.remove(),alert("Imagen eliminada correctamente.")):response.status===500?alert("El estado de la imagen fue actualizado, pero no se pudo eliminar de Wasabi."):alert("Error al eliminar la imagen.")}).catch(n=>{console.error("Error al eliminar la imagen:",n),alert("Hubo un error al eliminar la imagen.")})})});let t=[];L(h,o,C),I.addEventListener("shown.bs.modal",()=>f(d.dataset.unidadId)),d.addEventListener("click",()=>S(d.dataset.unidadId));function L(e,a,n){!e||!a||(e.addEventListener("click",()=>a.click()),a.addEventListener("change",()=>g(Array.from(a.files),n)),b(e,n))}function b(e,a){e.addEventListener("dragover",n=>n.preventDefault()),e.addEventListener("dragleave",()=>e.classList.remove("dragover")),e.addEventListener("drop",n=>{n.preventDefault(),e.classList.remove("dragover"),g(Array.from(n.dataTransfer.files),a)})}function g(e,a){e.forEach(n=>y(n)&&a(n)),o.disabled=t.length>=m}function y(e){return e.size>v?r(`La imagen ${e.name} supera el tamaño máximo de 4000KB.`):["image/jpeg","image/png","image/webp"].includes(e.type)?t.length>=m?r("Has alcanzado el límite de 50 imágenes."):!0:r(`El formato ${e.name} no es válido.`)}function C(e){t.push(e),D(e,l,()=>T(e.name))}function D(e,a,n){const i=new FileReader;i.onload=()=>{const F=E(i.result,e.name,n);a.appendChild(F)},i.readAsDataURL(e)}function E(e,a,n){const i=document.createElement("div");return i.classList.add("image-preview"),i.innerHTML=`
          <img src="${e}" alt="${a}">
          <button class="remove-image-btn btn-close">
              <i class="fa-solid fa-xmark"></i>
          </button>
      `,i.querySelector(".remove-image-btn").addEventListener("click",()=>{n(),i.remove()}),i}function T(e){t=t.filter(a=>a.name!==e),o.disabled=t.length>=m}function S(e){if(!e||t.length===0)return r("Por favor, seleccione una unidad e imágenes.");const a=new FormData;t.forEach(n=>a.append("images[]",n)),u(!0),fetch(`/unidades/${e}/imagenes`,{method:"POST",body:a,headers:{"X-CSRF-TOKEN":s}}).then(n=>n.json()).then(n=>{r("Imágenes subidas correctamente."),t=[],l.innerHTML="",f(e)}).catch(()=>r("Hubo un error al subir las imágenes.")).finally(()=>{u(!1)})}function f(e){e&&(c.innerHTML="",fetch(`/unidades/${e}/imagenes`,{method:"GET",headers:{"X-CSRF-TOKEN":s}}).then(a=>a.json()).then(a=>a.images.forEach(B)).catch(()=>r("Error al cargar las imágenes.")))}function B(e){const a=E(e.image_url,"Imagen de la Unidad",()=>x(e.id,a));c.appendChild(a)}function x(e,a){confirm("¿Estás seguro de que deseas eliminar esta imagen?")&&fetch(`/unidades/imagenes/${e}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":s}}).then(n=>n.json()).then(n=>n.success&&a.remove()).catch(()=>r("Error al eliminar la imagen."))}function r(e){alert(e)}});
