document.addEventListener("DOMContentLoaded",function(){const s=document.getElementById("unidadImgUploadButton"),o=document.getElementById("unidadImgInput"),f=document.getElementById("unidadImgDropZone"),l=document.getElementById("unidadImgPreviewContainer"),c=document.getElementById("unidadExistingImagesContainer"),h=document.getElementById("unidadImgUploadModal"),d=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),I=400*1024,m=50;document.querySelectorAll(".delete-image-unidad-btn").forEach(e=>{e.addEventListener("click",function(){const a=this.dataset.id;confirm("¿Seguro de que deseas eliminar esta imagen de la unidad?")&&fetch(`/unidades/imagenes/${a}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":d}}).then(n=>n.json()).then(n=>{n.message==="Imagen eliminada correctamente."?(this.parentElement.remove(),alert("Imagen eliminada correctamente.")):response.status===500?alert("El estado de la imagen fue actualizado, pero no se pudo eliminar de Wasabi."):alert("Error al eliminar la imagen.")}).catch(n=>{console.error("Error al eliminar la imagen:",n),alert("Hubo un error al eliminar la imagen.")})})});let t=[];v(f,o,b),h.addEventListener("shown.bs.modal",()=>E(s.dataset.unidadId)),s.addEventListener("click",()=>T(s.dataset.unidadId));function v(e,a,n){!e||!a||(e.addEventListener("click",()=>a.click()),a.addEventListener("change",()=>u(Array.from(a.files),n)),p(e,n))}function p(e,a){e.addEventListener("dragover",n=>n.preventDefault()),e.addEventListener("dragleave",()=>e.classList.remove("dragover")),e.addEventListener("drop",n=>{n.preventDefault(),e.classList.remove("dragover"),u(Array.from(n.dataTransfer.files),a)})}function u(e,a){e.forEach(n=>L(n)&&a(n)),o.disabled=t.length>=m}function L(e){return e.size>I?r(`La imagen ${e.name} supera el tamaño máximo de 400KB.`):["image/jpeg","image/png","image/webp"].includes(e.type)?t.length>=m?r("Has alcanzado el límite de 50 imágenes."):!0:r(`El formato ${e.name} no es válido.`)}function b(e){t.push(e),y(e,l,()=>D(e.name))}function y(e,a,n){const i=new FileReader;i.onload=()=>{const x=g(i.result,e.name,n);a.appendChild(x)},i.readAsDataURL(e)}function g(e,a,n){const i=document.createElement("div");return i.classList.add("image-preview"),i.innerHTML=`
          <img src="${e}" alt="${a}">
          <button class="remove-image-btn btn-close">
              <i class="fa-solid fa-xmark"></i>
          </button>
      `,i.querySelector(".remove-image-btn").addEventListener("click",()=>{n(),i.remove()}),i}function D(e){t=t.filter(a=>a.name!==e),o.disabled=t.length>=m}function T(e){if(!e||t.length===0)return r("Por favor, seleccione una unidad e imágenes.");const a=new FormData;t.forEach(n=>a.append("images[]",n)),fetch(`/unidades/${e}/imagenes`,{method:"POST",body:a,headers:{"X-CSRF-TOKEN":d}}).then(n=>n.json()).then(n=>{r("Imágenes subidas correctamente."),t=[],l.innerHTML="",E(e)}).catch(()=>r("Hubo un error al subir las imágenes."))}function E(e){e&&(c.innerHTML="",fetch(`/unidades/${e}/imagenes`,{method:"GET",headers:{"X-CSRF-TOKEN":d}}).then(a=>a.json()).then(a=>a.images.forEach(C)).catch(()=>r("Error al cargar las imágenes.")))}function C(e){const a=g(e.image_url,"Imagen de la Unidad",()=>B(e.id,a));c.appendChild(a)}function B(e,a){confirm("¿Estás seguro de que deseas eliminar esta imagen?")&&fetch(`/unidades/imagenes/${e}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":d}}).then(n=>n.json()).then(n=>n.success&&a.remove()).catch(()=>r("Error al eliminar la imagen."))}function r(e){alert(e)}});
