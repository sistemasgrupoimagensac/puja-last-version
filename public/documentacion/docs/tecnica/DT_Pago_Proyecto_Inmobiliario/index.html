<!doctype html>
<html lang="es" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tecnica/DT_Pago_Proyecto_Inmobiliario" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.3">
<title data-rh="true">Pago Proyecto Inmobiliario | Puja Inmobiliaria</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="http://test.com/documentacion/docs/tecnica/DT_Pago_Proyecto_Inmobiliario"><meta data-rh="true" property="og:locale" content="es"><meta data-rh="true" name="docusaurus_locale" content="es"><meta data-rh="true" name="docsearch:language" content="es"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Pago Proyecto Inmobiliario | Puja Inmobiliaria"><meta data-rh="true" name="description" content="1. Resumen"><meta data-rh="true" property="og:description" content="1. Resumen"><link data-rh="true" rel="icon" href="/documentacion/img/favicon.png"><link data-rh="true" rel="canonical" href="http://test.com/documentacion/docs/tecnica/DT_Pago_Proyecto_Inmobiliario"><link data-rh="true" rel="alternate" href="http://test.com/documentacion/docs/tecnica/DT_Pago_Proyecto_Inmobiliario" hreflang="es"><link data-rh="true" rel="alternate" href="http://test.com/documentacion/docs/tecnica/DT_Pago_Proyecto_Inmobiliario" hreflang="x-default"><link rel="stylesheet" href="/documentacion/assets/css/styles.0d7a9544.css">
<script src="/documentacion/assets/js/runtime~main.ac3897b2.js" defer="defer"></script>
<script src="/documentacion/assets/js/main.4ea88bdd.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Saltar al contenido principal"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Saltar al contenido principal</a></div><nav aria-label="Principal" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a href="https://www.pujainmobiliaria.com.pe" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/documentacion/img/favicon.png" alt="Logo de Puja Inmobiliaria" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/documentacion/img/favicon.png" alt="Logo de Puja Inmobiliaria" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Puja Inmobiliaria</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Cambiar entre modo oscuro y claro (actualmente modo claro)" aria-label="Cambiar entre modo oscuro y claro (actualmente modo claro)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Volver al principio" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Barra lateral de Documentos" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/documentacion/docs/intro">Introducción</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/documentacion/docs/funcional/DF_Registro_Usuario">Documentos Funcionales</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/documentacion/docs/tecnica/DT_Registro_Usuario">Documentos Técnicos</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/documentacion/docs/tecnica/DT_Registro_Usuario">Registro de Usuario</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/documentacion/docs/tecnica/DT_Registro_Usuario_Google">Registro con Google</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/documentacion/docs/tecnica/DT_Iniciar_Sesion">Inicio de Sesión</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/documentacion/docs/tecnica/DT_Iniciar_Sesion_Google">Inicio de Sesión con Google</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/documentacion/docs/tecnica/DT_Publicar_Inmueble_Propietario">Publicar Inmueble Propietario</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/documentacion/docs/tecnica/DT_Publicar_Inmueble_Corredor">Publicar Inmueble Corredor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/documentacion/docs/tecnica/DT_Publicar_Inmueble_Acreedor">Publicar Inmueble Acreedor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/documentacion/docs/tecnica/DT_Publicar_Proyecto_Inmobiliario">Publicar Proyecto Inmobiliario</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/documentacion/docs/tecnica/DT_Crear_Usuario_Proyecto_Inmobiliario">Crear Usuario Proyecto Inmobiliario</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/documentacion/docs/tecnica/DT_Pago_Propietario_Corredor_Acreedor">Pago Propietario, Corredor, Acreedor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/documentacion/docs/tecnica/DT_Pago_Proyecto_Inmobiliario">Pago Proyecto Inmobiliario</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/documentacion/docs/tecnica/DT_Manejo_Leads_Proyecto">Manejo de Leads Proyecto</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/documentacion/docs/tecnica/DT_Agregar_GoogleSheet_Proyecto">Agregar GoogleSheet a Proyecto</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/documentacion/docs/usuario/MU_Registro_Usuario">Manual de Usuario</a></div></li></ul></nav><button type="button" title="Colapsar barra lateral" aria-label="Colapsar barra lateral" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Rastro de navegación"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Página de Inicio" class="breadcrumbs__link" href="/documentacion/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Documentos Técnicos</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Pago Proyecto Inmobiliario</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">En esta página</button></div><div class="theme-doc-markdown markdown"><header><h1>Documento Técnico: Pago de Proyectos Inmobiliarios</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-resumen">1. Resumen<a href="#1-resumen" class="hash-link" aria-label="Enlace directo al 1. Resumen" title="Enlace directo al 1. Resumen">​</a></h2>
<p><strong>Descripción:</strong> Este documento detalla el flujo técnico del sistema de pagos para proyectos inmobiliarios. El flujo incluye pagos iniciales (50%) o pagos únicos completos según el contrato (<code>pago_fraccionado</code> o <code>pago_unico</code>). Se utiliza OpenPay para procesar los pagos de manera segura.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-requisitos-funcionales-relacionados">2. Requisitos Funcionales Relacionados<a href="#2-requisitos-funcionales-relacionados" class="hash-link" aria-label="Enlace directo al 2. Requisitos Funcionales Relacionados" title="Enlace directo al 2. Requisitos Funcionales Relacionados">​</a></h2>
<ul>
<li><strong>RF002:</strong> Permitir pagos mediante tarjeta de crédito/débito utilizando OpenPay.</li>
<li><strong>RF003:</strong> Registrar transacciones de pago asociadas a clientes de proyectos inmobiliarios.</li>
<li><strong>RF004:</strong> Generar comprobantes electrónicos tras el pago exitoso.</li>
</ul>
<table><thead><tr><th><strong>ID</strong></th><th><strong>Nombre del Requisito</strong></th><th><strong>Descripción</strong></th></tr></thead><tbody><tr><td><code>RF011</code></td><td>Pago de Proyectos Inmobiliarios</td><td>Permite pagos asociados a clientes de proyectos inmobiliarios</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-base-de-datos-relacionada">3. Base de Datos Relacionada<a href="#3-base-de-datos-relacionada" class="hash-link" aria-label="Enlace directo al 3. Base de Datos Relacionada" title="Enlace directo al 3. Base de Datos Relacionada">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tablas-implicadas">Tablas Implicadas<a href="#tablas-implicadas" class="hash-link" aria-label="Enlace directo al Tablas Implicadas" title="Enlace directo al Tablas Implicadas">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tabla-proyecto_clientes"><strong>Tabla: proyecto_clientes</strong><a href="#tabla-proyecto_clientes" class="hash-link" aria-label="Enlace directo al tabla-proyecto_clientes" title="Enlace directo al tabla-proyecto_clientes">​</a></h4>
<p><strong>Propósito:</strong><br>
<!-- -->Esta tabla almacena información detallada sobre los clientes asociados a proyectos inmobiliarios, incluyendo datos personales, condiciones del contrato y el estado del cliente respecto a sus pagos.</p>
<table><thead><tr><th><strong>Columna</strong></th><th><strong>Tipo</strong></th><th><strong>Descripción</strong></th></tr></thead><tbody><tr><td>id</td><td>BIGINT</td><td>Identificador único del cliente del proyecto.</td></tr><tr><td>user_id</td><td>BIGINT</td><td>Relación con la tabla <code>users</code>.</td></tr><tr><td>razon_social</td><td>VARCHAR(255)</td><td>Nombre o razón social del cliente.</td></tr><tr><td>ruc</td><td>VARCHAR(20)</td><td>Número de RUC del cliente.</td></tr><tr><td>direccion_fiscal</td><td>VARCHAR(255)</td><td>Dirección fiscal del cliente.</td></tr><tr><td>telefono_inmobiliaria</td><td>VARCHAR(15)</td><td>Teléfono de la inmobiliaria (opcional).</td></tr><tr><td>nombre_comercial</td><td>VARCHAR(255)</td><td>Nombre comercial del cliente (opcional).</td></tr><tr><td>representante_legal</td><td>VARCHAR(255)</td><td>Nombre del representante legal del cliente (opcional).</td></tr><tr><td>direccion_representante</td><td>VARCHAR(255)</td><td>Dirección del representante legal (opcional).</td></tr><tr><td>nombre_contacto</td><td>VARCHAR(255)</td><td>Nombre del contacto principal.</td></tr><tr><td>telefono_contacto</td><td>VARCHAR(15)</td><td>Teléfono del contacto principal.</td></tr><tr><td>email_contacto</td><td>VARCHAR(255)</td><td>Correo electrónico del contacto principal.</td></tr><tr><td>fecha_inicio_contrato</td><td>DATE</td><td>Fecha de inicio del contrato.</td></tr><tr><td>fecha_fin_contrato</td><td>DATE</td><td>Fecha de fin del contrato.</td></tr><tr><td>numero_anuncios</td><td>INTEGER</td><td>Cantidad de anuncios incluidos en el plan.</td></tr><tr><td>habilitado</td><td>BOOLEAN</td><td>Indica si el cliente está habilitado.</td></tr><tr><td>activo</td><td>BOOLEAN</td><td>Indica si el cliente está activo en el sistema.</td></tr><tr><td>vigente</td><td>BOOLEAN</td><td>Indica si el contrato está vigente.</td></tr><tr><td>precio_plan</td><td>DECIMAL(10,2)</td><td>Precio total del plan contratado.</td></tr><tr><td>periodo_plan</td><td>INTEGER</td><td>Duración del plan en meses.</td></tr><tr><td>pago_unico</td><td>BOOLEAN</td><td>Indica si el pago es único.</td></tr><tr><td>pago_fraccionado</td><td>BOOLEAN</td><td>Indica si el pago es fraccionado.</td></tr><tr><td>al_dia</td><td>BOOLEAN</td><td>Indica si el cliente está al día con los pagos.</td></tr><tr><td>pagado</td><td>BOOLEAN</td><td>Indica si el plan fue completamente pagado.</td></tr><tr><td>renovacion</td><td>BOOLEAN</td><td>Indica si el contrato es renovable.</td></tr><tr><td>contrato_url</td><td>VARCHAR(255)</td><td>URL del contrato en formato digital.</td></tr><tr><td>created_at</td><td>TIMESTAMP</td><td>Fecha de creación del registro.</td></tr><tr><td>updated_at</td><td>TIMESTAMP</td><td>Fecha de última actualización del registro.</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tabla-proyecto_cronograma_pagos"><strong>Tabla: proyecto_cronograma_pagos</strong><a href="#tabla-proyecto_cronograma_pagos" class="hash-link" aria-label="Enlace directo al tabla-proyecto_cronograma_pagos" title="Enlace directo al tabla-proyecto_cronograma_pagos">​</a></h4>
<p><strong>Propósito:</strong><br>
<!-- -->Registra los pagos programados de clientes con opción de pago fraccionado, detallando fechas, montos y estados de cada pago.</p>
<table><thead><tr><th><strong>Columna</strong></th><th><strong>Tipo</strong></th><th><strong>Descripción</strong></th></tr></thead><tbody><tr><td>id</td><td>BIGINT</td><td>Identificador único del cronograma de pago.</td></tr><tr><td>proyecto_cliente_id</td><td>BIGINT</td><td>Relación con la tabla <code>proyecto_clientes</code>.</td></tr><tr><td>fecha_programada</td><td>DATE</td><td>Fecha programada para el cobro.</td></tr><tr><td>monto</td><td>DECIMAL(10, 2)</td><td>Monto del pago programado.</td></tr><tr><td>estado</td><td>ENUM</td><td>Estado del pago (<code>pendiente</code>, <code>pagado</code>, etc.).</td></tr><tr><td>intentos</td><td>UNSIGNED INTEGER</td><td>Número de intentos realizados para el cobro.</td></tr><tr><td>reintento_hasta</td><td>DATE</td><td>Fecha límite para reintentos.</td></tr><tr><td>fecha_ultimo_intento</td><td>DATETIME</td><td>Fecha del último intento de cobro.</td></tr><tr><td>razon_fallo</td><td>VARCHAR(255)</td><td>Razón del fallo del cobro (si aplica).</td></tr><tr><td>fallo_final</td><td>BOOLEAN</td><td>Indica si el pago falló después de todos los reintentos.</td></tr><tr><td>created_at</td><td>TIMESTAMP</td><td>Fecha de creación del registro.</td></tr><tr><td>updated_at</td><td>TIMESTAMP</td><td>Fecha de última actualización del registro.</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="relaciones-de-las-tablas">Relaciones de las Tablas<a href="#relaciones-de-las-tablas" class="hash-link" aria-label="Enlace directo al Relaciones de las Tablas" title="Enlace directo al Relaciones de las Tablas">​</a></h2>
<!-- -->
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-flujo-de-trabajo">4. Flujo de Trabajo<a href="#4-flujo-de-trabajo" class="hash-link" aria-label="Enlace directo al 4. Flujo de Trabajo" title="Enlace directo al 4. Flujo de Trabajo">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="flujo-general">Flujo General<a href="#flujo-general" class="hash-link" aria-label="Enlace directo al Flujo General" title="Enlace directo al Flujo General">​</a></h3>
<ol>
<li>
<p><strong>Inicio de Sesión:</strong><br>
<!-- -->Al iniciar sesión, si el usuario tiene pagos pendientes (<code>al_dia</code> = false), se redirige a la vista <code>/proyecto-pago</code>.</p>
</li>
<li>
<p><strong>Vista de Pago:</strong><br>
<!-- -->En <code>proyecto-pago.blade.php</code> se presenta:</p>
<ul>
<li>Detalles del plan contratado.</li>
<li>Formulario de pago con tarjeta.</li>
<li>Selección de RUC o DNI para comprobantes.</li>
</ul>
</li>
<li>
<p><strong>Procesamiento del Pago:</strong></p>
<ul>
<li><strong>Crear Cliente:</strong> Se registra el cliente en OpenPay.</li>
<li><strong>Asociar Tarjeta:</strong> Se tokeniza la tarjeta y se asocia al cliente.</li>
<li><strong>Realizar Débito:</strong> Se procesa el pago.</li>
<li><strong>Post-Pago:</strong>
<ul>
<li>Registro de transacción.</li>
<li>Generación de comprobantes electrónicos.</li>
<li>Actualización del estado del cliente.</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-scripts-relacionados">5. Scripts Relacionados<a href="#5-scripts-relacionados" class="hash-link" aria-label="Enlace directo al 5. Scripts Relacionados" title="Enlace directo al 5. Scripts Relacionados">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="proyecto-pagobladephp"><strong>proyecto-pago.blade.php</strong><a href="#proyecto-pagobladephp" class="hash-link" aria-label="Enlace directo al proyecto-pagobladephp" title="Enlace directo al proyecto-pagobladephp">​</a></h3>
<p>El archivo <code>proyecto-pago.blade.php</code> contiene los scripts que gestionan el flujo de pago en el frontend. Este flujo incluye la validación del estado del cliente, la generación de un token de tarjeta, la asociación de la tarjeta al cliente, y finalmente el procesamiento del pago. A continuación, se explican los principales scripts incluidos en esta vista.</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-confirmación-de-estado-del-pago">5.1. <strong>Confirmación de Estado del Pago</strong><a href="#51-confirmación-de-estado-del-pago" class="hash-link" aria-label="Enlace directo al 51-confirmación-de-estado-del-pago" title="Enlace directo al 51-confirmación-de-estado-del-pago">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="código">Código:<a href="#código" class="hash-link" aria-label="Enlace directo al Código:" title="Enlace directo al Código:">​</a></h4>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">confimarEstadoPago</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> dataProyectoClienteId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string-property property" style="color:#36acaa">&quot;proyectoClienteId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> $proyectoClienteId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;/confirmacion_pago_proyecto&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">headers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string-property property" style="color:#36acaa">&#x27;Accept&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;application/json&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string-property property" style="color:#36acaa">&#x27;Content-Type&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;application/json&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string-property property" style="color:#36acaa">&#x27;X-CSRF-TOKEN&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">querySelector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;meta[name=&quot;csrf-token&quot;]&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getAttribute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;content&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">body</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">stringify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataProyectoClienteId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">response</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> response</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">data</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">up_to_date</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">location</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;/login&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copiar código" title="Copiar" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="explicación">Explicación:<a href="#explicación" class="hash-link" aria-label="Enlace directo al Explicación:" title="Enlace directo al Explicación:">​</a></h4>
<p>Este script verifica si el cliente está al día con los pagos antes de permitirle realizar un nuevo pago.</p>
<ul>
<li>
<p><strong>Entrada:</strong><br>
<!-- -->El <code>proyectoClienteId</code> se envía al backend para buscar el estado actual del cliente en la tabla <code>proyecto_clientes</code>.</p>
</li>
<li>
<p><strong>Proceso:</strong></p>
<ol>
<li>Se realiza una petición <code>POST</code> al endpoint <code>/confirmacion_pago_proyecto</code>.</li>
<li>Se incluye un token CSRF para garantizar la seguridad de la solicitud.</li>
<li>El backend devuelve un JSON con el estado de <code>al_dia</code> del cliente.</li>
</ol>
</li>
<li>
<p><strong>Salida:</strong></p>
<ul>
<li>Si el cliente está al día (<code>up_to_date</code> es <code>true</code>), se redirige a la página de inicio de sesión (<code>/login</code>).</li>
<li>Si no está al día, el cliente permanece en la vista actual para proceder con el pago.</li>
</ul>
</li>
</ul>
<p>Este paso asegura que los clientes no puedan realizar pagos adicionales si no tienen deudas pendientes.</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="52-procesamiento-completo-del-pago">5.2. <strong>Procesamiento Completo del Pago</strong><a href="#52-procesamiento-completo-del-pago" class="hash-link" aria-label="Enlace directo al 52-procesamiento-completo-del-pago" title="Enlace directo al 52-procesamiento-completo-del-pago">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="código-1">Código:<a href="#código-1" class="hash-link" aria-label="Enlace directo al Código:" title="Enlace directo al Código:">​</a></h4>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">handleTokenSuccess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">response</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> source_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> $precio </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> proyectoClienteId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> $proyectoClienteId </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> formPost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        source_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;card&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">amount</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">currency</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;PEN&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">description</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{{ $descripcion }}&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">device_session_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">deviceSessionId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">customer</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{{ $razonSocial }}&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">phone_number</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{{ $telefono }}&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">email</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{{ $correo }}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createCustomer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">formPost</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">customer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">customer</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">associateCardToCustomer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">customer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> formPost</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">source_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> formPost</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">device_session_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">cardData</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">realizarDebitoInicial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">formPost</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cardData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> proyectoClienteId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copiar código" title="Copiar" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="explicación-1">Explicación:<a href="#explicación-1" class="hash-link" aria-label="Enlace directo al Explicación:" title="Enlace directo al Explicación:">​</a></h4>
<p>Este script maneja todo el flujo de procesamiento de un pago, desde la creación de un cliente hasta el débito inicial.</p>
<ul>
<li>
<p><strong>Entrada:</strong></p>
<ul>
<li><code>response.data.id</code>: Token generado por OpenPay al capturar los datos de la tarjeta.</li>
<li><code>$precio</code>: Monto del pago, dinámicamente pasado desde la vista.</li>
<li><code>$proyectoClienteId</code>: Identificador del cliente del proyecto.</li>
</ul>
</li>
<li>
<p><strong>Proceso:</strong></p>
<ol>
<li><strong>Creación del Cliente:</strong>
<ul>
<li>Llama al método <code>createCustomer</code>, que registra los datos del cliente en OpenPay.</li>
</ul>
</li>
<li><strong>Asociación de la Tarjeta:</strong>
<ul>
<li>Usa el token generado por OpenPay (<code>source_id</code>) para asociar la tarjeta al cliente.</li>
</ul>
</li>
<li><strong>Realizar el Débito Inicial:</strong>
<ul>
<li>Procesa el cobro del monto especificado utilizando la tarjeta asociada.</li>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>Salida:</strong></p>
<ul>
<li>Si todo el proceso es exitoso, se realiza el débito inicial y se registra el pago en el backend.</li>
<li>Este flujo asegura que los datos del cliente y la tarjeta estén correctamente vinculados antes de procesar cualquier transacción.</li>
</ul>
</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="53-guardar-tarjeta-y-estado-del-proyecto">5.3. <strong>Guardar Tarjeta y Estado del Proyecto</strong><a href="#53-guardar-tarjeta-y-estado-del-proyecto" class="hash-link" aria-label="Enlace directo al 53-guardar-tarjeta-y-estado-del-proyecto" title="Enlace directo al 53-guardar-tarjeta-y-estado-del-proyecto">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="código-2">Código:<a href="#código-2" class="hash-link" aria-label="Enlace directo al Código:" title="Enlace directo al Código:">​</a></h4>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">saveCardData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">cardData</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> proyectoClienteId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;/guardar_tarjeta&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">headers</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string-property property" style="color:#36acaa">&#x27;Accept&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;application/json&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string-property property" style="color:#36acaa">&#x27;Content-Type&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;application/json&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string-property property" style="color:#36acaa">&#x27;X-CSRF-TOKEN&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">querySelector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;meta[name=&quot;csrf-token&quot;]&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getAttribute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;content&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token literal-property property" style="color:#36acaa">body</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">stringify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">proyecto_cliente_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> proyectoClienteId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">customer_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cardData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">customer_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">card_id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cardData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">card_brand</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cardData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">brand</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">card_last_digits</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cardData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">card_number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">expiration_month</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cardData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">expiration_month</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">expiration_year</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cardData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">expiration_year</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">holder_name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cardData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">holder_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cardData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copiar código" title="Copiar" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="explicación-2">Explicación:<a href="#explicación-2" class="hash-link" aria-label="Enlace directo al Explicación:" title="Enlace directo al Explicación:">​</a></h4>
<p>Este script guarda la información de la tarjeta utilizada para el pago en la base de datos.</p>
<ul>
<li>
<p><strong>Entrada:</strong></p>
<ul>
<li><code>cardData</code>: Objeto que contiene los datos de la tarjeta devueltos por OpenPay.</li>
<li><code>proyectoClienteId</code>: Identificador del cliente del proyecto.</li>
</ul>
</li>
<li>
<p><strong>Proceso:</strong></p>
<ol>
<li>Envía una solicitud <code>POST</code> al endpoint <code>/guardar_tarjeta</code>.</li>
<li>Incluye los datos de la tarjeta como:<!-- -->
<ul>
<li><code>customer_id</code> y <code>card_id</code>: Identificadores únicos de OpenPay.</li>
<li><code>card_brand</code>: Marca de la tarjeta (por ejemplo, Visa, MasterCard).</li>
<li><code>card_last_digits</code>: Últimos 4 dígitos de la tarjeta para referencia.</li>
<li>Fecha de expiración y nombre del titular.</li>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>Salida:</strong></p>
<ul>
<li>Si la tarjeta se guarda correctamente, estará disponible para futuros pagos o renovaciones.</li>
<li>Este paso es fundamental para simplificar pagos recurrentes y mejorar la experiencia del cliente.</li>
</ul>
</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="resumen-de-la-funcionalidad">Resumen de la Funcionalidad<a href="#resumen-de-la-funcionalidad" class="hash-link" aria-label="Enlace directo al Resumen de la Funcionalidad" title="Enlace directo al Resumen de la Funcionalidad">​</a></h3>
<ul>
<li><strong>Validación del Estado del Cliente:</strong> Asegura que los clientes no puedan realizar pagos si están al día.</li>
<li><strong>Flujo de Pago Completo:</strong> Gestiona la creación del cliente, la asociación de la tarjeta y el débito inicial.</li>
<li><strong>Registro de la Tarjeta:</strong> Permite guardar los datos de la tarjeta para futuros pagos.</li>
</ul>
<p>Estos scripts trabajan conjuntamente para ofrecer un flujo de pago seguro, eficiente y orientado a una buena experiencia del cliente.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-rutas-y-métodos-relacionados">6. Rutas y Métodos Relacionados<a href="#6-rutas-y-métodos-relacionados" class="hash-link" aria-label="Enlace directo al 6. Rutas y Métodos Relacionados" title="Enlace directo al 6. Rutas y Métodos Relacionados">​</a></h2>
<table><thead><tr><th><strong>Ruta</strong></th><th><strong>Método</strong></th><th><strong>Controlador</strong></th><th><strong>Descripción</strong></th></tr></thead><tbody><tr><td>/confirmacion_pago_proyecto</td><td>POST</td><td>ConfirmacionPagoAntesDeDebitar</td><td>Verifica si el cliente está al día antes de procesar el pago.</td></tr><tr><td>/guardar_tarjeta</td><td>POST</td><td>CustomerCardController@store</td><td>Guarda los datos de la tarjeta en la base de datos.</td></tr><tr><td>/realizar_debito</td><td>POST</td><td>PlanController@realizarDebito</td><td>Procesa el pago con OpenPay.</td></tr><tr><td>/crear_cliente</td><td>POST</td><td>PlanController@crearCliente</td><td>Registra un cliente en OpenPay.</td></tr><tr><td>/asociar_tarjeta</td><td>POST</td><td>PlanController@asociarTarjeta</td><td>Asocia una tarjeta tokenizada al cliente en OpenPay.</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-interacciones-del-backend-con-openpay">7. Interacciones del Backend con OpenPay<a href="#7-interacciones-del-backend-con-openpay" class="hash-link" aria-label="Enlace directo al 7. Interacciones del Backend con OpenPay" title="Enlace directo al 7. Interacciones del Backend con OpenPay">​</a></h2>
<ol>
<li>
<p><strong>Crear Cliente</strong></p>
<ul>
<li>Ruta: <code>/crear_cliente</code></li>
<li>Lógica: Registra un cliente en OpenPay usando su nombre, correo y teléfono.</li>
</ul>
</li>
<li>
<p><strong>Asociar Tarjeta</strong></p>
<ul>
<li>Ruta: <code>/asociar_tarjeta</code></li>
<li>Lógica: Usa un token generado por OpenPay para asociar la tarjeta al cliente.</li>
</ul>
</li>
<li>
<p><strong>Realizar Débito</strong></p>
<ul>
<li>Ruta: <code>/realizar_debito</code></li>
<li>Lógica:<!-- -->
<ul>
<li>Procesa el cargo usando <code>customer_id</code> y <code>card_id</code>.</li>
<li>Devuelve detalles del estado del débito.</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="8-post-proceso-tras-el-débito">8. Post-Proceso tras el Débito<a href="#8-post-proceso-tras-el-débito" class="hash-link" aria-label="Enlace directo al 8. Post-Proceso tras el Débito" title="Enlace directo al 8. Post-Proceso tras el Débito">​</a></h2>
<ul>
<li>
<p><strong>Actualizar Estado del Cliente:</strong></p>
<ul>
<li>Campos como <code>al_dia</code> y <code>pagado</code> son actualizados en <code>proyecto_clientes</code>.</li>
</ul>
</li>
<li>
<p><strong>Registro de Transacción:</strong></p>
<ul>
<li>Detalles del pago son almacenados en la base de datos.</li>
</ul>
</li>
<li>
<p><strong>Generación de Comprobante Electrónico:</strong></p>
<ul>
<li>Integración para emitir comprobantes tras un pago exitoso.</li>
</ul>
</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="9-historial-de-cambios">9. Historial de Cambios<a href="#9-historial-de-cambios" class="hash-link" aria-label="Enlace directo al 9. Historial de Cambios" title="Enlace directo al 9. Historial de Cambios">​</a></h2>
<table><thead><tr><th><strong>Versión</strong></th><th><strong>Fecha</strong></th><th><strong>Cambios Realizados</strong></th><th><strong>Autor</strong></th></tr></thead><tbody><tr><td>v1.0</td><td>1/12/2024</td><td>Documento técnico inicial creado.</td><td>Equipo de Desarrollo</td></tr></tbody></table></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Página del documento"><a class="pagination-nav__link pagination-nav__link--prev" href="/documentacion/docs/tecnica/DT_Pago_Propietario_Corredor_Acreedor"><div class="pagination-nav__sublabel">Anterior</div><div class="pagination-nav__label">Pago Propietario, Corredor, Acreedor</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/documentacion/docs/tecnica/DT_Manejo_Leads_Proyecto"><div class="pagination-nav__sublabel">Siguiente</div><div class="pagination-nav__label">Manejo de Leads Proyecto</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-resumen" class="table-of-contents__link toc-highlight">1. Resumen</a></li><li><a href="#2-requisitos-funcionales-relacionados" class="table-of-contents__link toc-highlight">2. Requisitos Funcionales Relacionados</a></li><li><a href="#3-base-de-datos-relacionada" class="table-of-contents__link toc-highlight">3. Base de Datos Relacionada</a><ul><li><a href="#tablas-implicadas" class="table-of-contents__link toc-highlight">Tablas Implicadas</a></li></ul></li><li><a href="#relaciones-de-las-tablas" class="table-of-contents__link toc-highlight">Relaciones de las Tablas</a></li><li><a href="#4-flujo-de-trabajo" class="table-of-contents__link toc-highlight">4. Flujo de Trabajo</a><ul><li><a href="#flujo-general" class="table-of-contents__link toc-highlight">Flujo General</a></li></ul></li><li><a href="#5-scripts-relacionados" class="table-of-contents__link toc-highlight">5. Scripts Relacionados</a><ul><li><a href="#proyecto-pagobladephp" class="table-of-contents__link toc-highlight"><strong>proyecto-pago.blade.php</strong></a></li><li><a href="#51-confirmación-de-estado-del-pago" class="table-of-contents__link toc-highlight">5.1. <strong>Confirmación de Estado del Pago</strong></a></li><li><a href="#52-procesamiento-completo-del-pago" class="table-of-contents__link toc-highlight">5.2. <strong>Procesamiento Completo del Pago</strong></a></li><li><a href="#53-guardar-tarjeta-y-estado-del-proyecto" class="table-of-contents__link toc-highlight">5.3. <strong>Guardar Tarjeta y Estado del Proyecto</strong></a></li><li><a href="#resumen-de-la-funcionalidad" class="table-of-contents__link toc-highlight">Resumen de la Funcionalidad</a></li></ul></li><li><a href="#6-rutas-y-métodos-relacionados" class="table-of-contents__link toc-highlight">6. Rutas y Métodos Relacionados</a></li><li><a href="#7-interacciones-del-backend-con-openpay" class="table-of-contents__link toc-highlight">7. Interacciones del Backend con OpenPay</a></li><li><a href="#8-post-proceso-tras-el-débito" class="table-of-contents__link toc-highlight">8. Post-Proceso tras el Débito</a></li><li><a href="#9-historial-de-cambios" class="table-of-contents__link toc-highlight">9. Historial de Cambios</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Blog</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://pujainmobiliaria.com.pe/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">link<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Redes</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.facebook.com/pujainmobiliaria" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.instagram.com/pujainmobiliaria/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Puja Inmobiliaria</div></div></div></footer></div>
</body>
</html>